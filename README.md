# Arnold's

Arnold's is the place where all FUN's applications are assembled and deployed to `OpenShift` as `Docker` services.

A customer site is installed in several environments:
  * **feature:** one environment for each feature branch, the feature being described by its title (**e.g** feat/99-change-background-color),
  * **staging:** aggregating all features before a release,
  * **preprod:** validating a release before going live,
  * **production:** customer facing operations.

In order to deploy our applications, we need to generate configuration files customized for each project, being defined by a customer site AND an environment.


# Project and app names

The project name is used for `OpenShift` projects and is generated using the following pattern::

    {{ environment }}-{{ customer }}[--{{ feature_name }}]

The application name is generated using the following pattern:

    {{ environment }}-{{ customer }}-{{ application }}[--{{ feature_name }}]

Where:

- **environment:** the name of the environment (feature, staging, preprod or prod)
- **customer:** the one-word name of the customer site (fun, campus, corporate, ademe, etc.)
- **application:** the one-word name of the application (lms, cms, etc.)
- **feature_title:** the slugified title of the feature. Only applicable when the `environment` is equal to `feature`.

The application name is used as a subdomain of `dev.openfun.fr` to compose urls, except for production environments where urls are set to the customer's domain.

Here are some examples of valid urls on the `dev.openfun.fr` platform:

- staging-campus-cms.dev.openfun.fr
- staging-campus-lms.dev.openfun.fr
- preprod-fun-lms.dev.openfun.fr
- feature-coporate-lms--change-background-color-on-contact-form.dev.openfun.fr

All these development urls are protected by basic authentication. For this purpose, an `htpasswd` file is generated in the `nginx` container upon startup:

- the login is set to the one-word customer name,
- the password is an auto-generated secret (see below),
- the login and password are used to generate the `htpasswd` file upon startup of the `nginx` container,
- the login and password are sent to the customer by email and posted in a dedicated `#deploy` Slack channel.


# Secrets

We must distinguish two types of secrets recorded in `OpenShift`.

## 1. Third-party credentials

These secrets are login/passwords or tokens given by third party SaaS applications (e.g. Google Analytics, Sentry, etc.). They are known by the developer or manager who subscribed to the service.

They are recorded in a vault file (one per customer site) which is encrypted by developers using `Ansible Vault` and committed to Arnold's repository.

The vault file is decrypted by an init container in `OpenShift` and its values are mounted as environment variables in the application containers that need them.

The init container image is crafted by `Arnold`.

## 2. Auto-generated secrets

These secrets are login/passwords or tokens that are auto-generated by `OpenShift` upon project creation and recorded in `OpenShift`'s secrets store.

The `DJANGO_SECRET_KEY` setting or `MYSQL_PASSWORD` are examples of such secrets.

In the example of `Mysql` credentials: `OpenShift` generates a random password, creates the database in the `Mysql` cluster and records the password in its secret store. As a result, no one is aware of those credentials.

These actions are performed by a job, run upon project creation and based on a `Docker` container called `project_creator`. The `Docker` image is crafted by Arnold.

These secrets are mounted as environment variables in the application containers that need them.


# Quick start

The Ansible playbooks in Arnold are best run with `Docker`.

Make sure you have a recent version of `Docker` installed on your laptop:

    $ docker -v
      Docker version 17.12.0-ce, build c97c6d6

And build Arnold's `Docker` image:

    $  docker build -t arnold-ansible

To login to OpenShift, you also need a recent version of the [OC](https://docs.openshift.com/enterprise/3.0/cli_reference/get_started_cli.html) client installed:

    $ oc version
      oc v3.9.0-alpha.3+78ddc10
      kubernetes v1.9.1+a0ce1bc657
      features: Basic-Auth GSSAPI Kerberos SPNEGO

      Server https://console.dev.openfun.fr:8443
      openshift v3.7.1+c2ce2c0-1
      kubernetes v1.7.6+a08f5eeb62

And login to OpenShift:

    $ oc login https://console.dev.openfun.fr:8443 --username=fun --password=xxxxx


## Deployment

The deployment files are compiled by injecting project variables in a set of `Ansible` templates and sent to `OpenShift` using Ansible's `openshit_raw` module.

To synchronize the deployment files with `OpenShift`, run:

    $  docker run -it -v $PWD:/app -u $(id -u):$(id -g) -e ANSIBLE_VAULT_PASS=xxxxx -e K8S_AUTH_API_KEY=$(oc whoami -t) -e K8S_AUTH_HOST=https://console.dev.openfun.fr:8443 arnold-ansible ansible-playbook deploy.yml -e "customer=corporate env_type=preprod"

The default env_type is `staging`.
The default customer is `patient0`, a demo site with default configuration.

For a `feature` environment, you should also set a `feature_title` variable with a slug describing the feature:

    .../... ansible-playbook deploy.yml -e "env_type=feature feature_title=change-background-color"

The corresponding objects should now be available in `OpenShift`.
